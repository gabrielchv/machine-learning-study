<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Task Helper AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { height: calc(100vh - 240px); }
        body { background-color: #1a1a1a; }
        header { padding-top: env(safe-area-inset-top, 16px) !important; padding-bottom: 16px !important; }
        
        /* Previne zoom no iOS */
        #input { font-size: 16px !important; }

        /* Spinner de carregamento */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* √çcone de envio rotacionado */
        .send-icon { transform: rotate(90deg); }

        /* Anima√ß√£o de grava√ß√£o */
        .recording { 
            animation: pulse 1.5s infinite; 
            background-color: #ef4444 !important; 
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex justify-center overflow-hidden">

    <div class="w-full max-w-md bg-gray-100 flex flex-col shadow-2xl relative">
        <header class="bg-blue-600 text-white text-center font-bold shadow-md">
            Task Helper AI
        </header>

        <div id="chat" class="chat-container overflow-y-auto p-4 space-y-4 flex flex-col">
            <div class="bg-white p-3 rounded-lg shadow-sm max-w-[85%] text-sm text-gray-800">
                Ol√°! Digite ou <strong>segure</strong> o microfone para falar suas tarefas.
            </div>
        </div>

        <div class="p-4 bg-white border-t" style="padding-bottom: calc(env(safe-area-inset-bottom, 16px) + 16px);">
            <div class="flex gap-2 items-center">
                <button id="mic-btn" 
                    onmousedown="startRecording()" onmouseup="stopRecording()"
                    ontouchstart="startRecording()" ontouchend="stopRecording()"
                    class="bg-gray-200 text-gray-600 p-2.5 rounded-full transition-all flex items-center justify-center min-w-[40px] min-h-[40px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14c1.657 0 3-1.343 3-3V5a3 3 0 10-6 0v6c0 1.657 1.343 3 3 3z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>

                <input type="text" id="input" 
                    class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    placeholder="Digite...">
                
                <button onclick="sendText()" id="btn" 
                    class="bg-blue-600 text-white p-2.5 rounded-full hover:bg-blue-700 flex items-center justify-center min-w-[40px] min-h-[40px]">
                    <svg class="h-5 w-5 send-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
            
            <div class="mt-4 text-center">
                <a href="https://www.linkedin.com/in/gabriel-chv" target="_blank" 
                   class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold">
                    Gabriel Chaves | LinkedIn
                </a>
            </div>
        </div>
    </div>

    <script>
        // ATEN√á√ÉO: Verifique se esta URL est√° correta ap√≥s o deploy da function
        const FUNCTION_URL = "https://task-helper-662877194200.southamerica-east1.run.app";
        
        let mediaRecorder;
        let audioChunks = [];
        let startTime;

        // FUN√á√ÉO PARA AVISOS TEMPOR√ÅRIOS
        function showFeedback(message) {
            const chat = document.getElementById('chat');
            const alertDiv = document.createElement('div');
            alertDiv.className = "bg-yellow-100 text-yellow-800 p-2 rounded-lg self-center text-[10px] uppercase font-bold tracking-tighter mb-2";
            alertDiv.innerText = message;
            chat.appendChild(alertDiv);
            chat.scrollTop = chat.scrollHeight;
            setTimeout(() => alertDiv.remove(), 3000);
        }

        // L√ìGICA DE √ÅUDIO
        async function startRecording() {
            startTime = Date.now();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const duration = Date.now() - startTime;
                    if (duration < 500) {
                        showFeedback("‚ö†Ô∏è Segure para gravar √°udio");
                        return;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    processRequest(audioBlob, true);
                };
                mediaRecorder.start();
                document.getElementById('mic-btn').classList.add('recording', 'text-white');
            } catch (err) {
                showFeedback("‚ùå Permita o acesso ao microfone");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                document.getElementById('mic-btn').classList.remove('recording', 'text-white');
            }
        }

        // ENVIO DE TEXTO
        function sendText() {
            const input = document.getElementById('input');
            const val = input.value.trim();
            if (val) processRequest(val, false);
        }

        // PROCESSAMENTO (GEMINI)
        async function processRequest(content, isAudio) {
            const chat = document.getElementById('chat');
            const btn = document.getElementById('btn');
            const input = document.getElementById('input');
            
            btn.disabled = true;
            input.disabled = true;
            
            // UI: Mensagem do usu√°rio
            chat.innerHTML += `<div class="bg-blue-500 text-white p-3 rounded-lg self-end ml-auto max-w-[85%] text-sm shadow-sm">${isAudio ? 'üé§ Mensagem de voz' : content}</div>`;
            input.value = "";
            
            // UI: Loading
            const loadingId = "loading-" + Date.now();
            chat.innerHTML += `<div id="${loadingId}" class="bg-white p-3 rounded-lg shadow-sm max-w-[85%] text-sm text-gray-400 italic flex items-center gap-2 border border-gray-100">
                <div class="loader" style="width:12px; height:12px; border-width:1px;"></div> Gemini est√° processando...
            </div>`;
            chat.scrollTop = chat.scrollHeight;

            const formData = new FormData();
            if (isAudio) formData.append('audio', content);

            try {
                let res;
                if (isAudio) {
                    res = await fetch(FUNCTION_URL, { method: 'POST', body: formData });
                } else {
                    res = await fetch(FUNCTION_URL, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({text: content}) 
                    });
                }
                
                const data = await res.json();
                document.getElementById(loadingId).remove();

                // UI: Lista de Tarefas (Apenas T√≠tulo)
                let reply = "‚úÖ **Tarefas extra√≠das:**<br><div class='mt-2 space-y-2'>";
                if (data.tasks && data.tasks.length > 0) {
                    data.tasks.forEach(t => {
                        reply += `<div class='border-l-2 border-blue-500 pl-2'>
                                    <span class='font-bold block text-gray-800'>${t.title}</span>
                                  </div>`;
                    });
                } else {
                    reply = "N√£o identifiquei tarefas. Tente descrever o que precisa ser feito.";
                }
                reply += "</div>";

                chat.innerHTML += `<div class="bg-white p-3 rounded-lg shadow-sm max-w-[85%] text-sm text-gray-800 border border-gray-100">${reply}</div>`;
            } catch (e) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                chat.innerHTML += `<div class="bg-red-50 p-3 rounded-lg text-xs text-red-600 border border-red-100 text-center">Erro ao processar. Tente novamente.</div>`;
            } finally {
                btn.disabled = false;
                input.disabled = false;
                input.focus();
                chat.scrollTop = chat.scrollHeight;
            }
        }

        document.getElementById('input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendText(); });
    </script>
</body>
</html>